<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>„Å©„ÅÜ„Å∂„Å§ „Å≤„Åç„Åñ„ÇìÔºà„Ç∫„Éº„Éª„Ç≤„Éº„É†Ôºâ</title>
  <meta name="description" content="Â∞èÂ≠¶Ê†°‰ΩéÂ≠¶Âπ¥Âêë„Åë„ÅÆ„Å≤„ÅçÁÆó„Ç≤„Éº„É†„ÄÇ„Çµ„É´„Åå„Å´„Åí„Çã„Ç¢„Éã„É°„Åß 8 - 3 = ? „ÇíÊ•Ω„Åó„ÅèÂ≠¶„Åº„ÅÜÔºÅ„Çø„ÉÉ„Éó„Åó„Å¶„Åì„Åü„Åà„Çã„ÄÅ„ÇÑ„Åï„Åó„ÅÑ„Éí„É≥„Éà„ÄÅ„É¨„Éô„É´Ôºà„Åã„Çì„Åü„Çì/„Åµ„Å§„ÅÜÔºâ„ÄÅ„Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„ÄÅÈü≥„Å§„Åç„ÄÇ" />
  
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YSBGNQTYRZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-YSBGNQTYRZ');
  </script>
  
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg1: #c6ffdd; /* „Éö„É≥„ÅÆËÉåÊôØ„Ç∞„É©„Éá */
      --bg2: #fbd786;
      --bg3: #f7797d;
      --green: #2ecc71;
      --deep: #2d3436;
      --blue: #74b9ff;
      --yellow: #ffd166;
      --pink: #ff6b6b;
      --orange: #f39c12;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: 'Nunito', system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2), var(--bg3));
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      overflow: hidden;
    }

    .app {
      width: 100%;
      max-width: 920px;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 22px 44px rgba(0,0,0,0.12);
      padding: 16px 16px 12px;
      position: relative;
      overflow: hidden;
    }

    .title {
      text-align: center;
      font-size: 1.6rem;
      color: var(--pink);
      font-weight: 800;
      text-shadow: 0 2px 0 rgba(0,0,0,0.06);
      margin-bottom: 6px;
    }

    .hud {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 10px;
    }
    .equation {
      grid-column: 1 / -1;
      text-align: center;
      font-size: 2.2rem;
      font-weight: 800;
      letter-spacing: 2px;
      color: var(--deep);
    }
    .level-select {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-top: 6px;
    }
    .level-btn {
      background: linear-gradient(45deg, var(--blue), #6c5ce7);
      border: none;
      color: #fff;
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(108,92,231,0.3);
    }
    .level-btn.active { filter: brightness(1.05) saturate(1.1); outline: 3px solid rgba(255,255,255,0.6); }

    .stats {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 6px;
    }
    .pill {
      background: linear-gradient(45deg, var(--yellow), #f1c40f);
      color: #333;
      padding: 6px 12px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 0.95rem;
      box-shadow: 0 6px 14px rgba(241,196,15,0.3);
    }

    .progress-wrap {
      margin-top: 8px;
      background: #ecf0f1;
      border-radius: 12px;
      height: 14px;
      overflow: hidden;
      border: 2px solid #dfe6e9;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--green), #27ae60);
      transition: width 0.4s ease;
    }

    .pen {
      position: relative;
      margin-top: 12px;
      background: linear-gradient(180deg, #fefefe, #f7fff7);
      border: 4px solid #a3d9a5;
      border-radius: 18px;
      min-height: 280px;
      padding: 14px;
      overflow: hidden;
    }
    .pen .label {
      position: absolute;
      top: 8px;
      left: 12px;
      background: #fff;
      border: 3px solid var(--green);
      color: #1e824c;
      font-weight: 800;
      border-radius: 12px;
      padding: 6px 10px;
      z-index: 2;
    }
    .ground {
      position: absolute;
      left: -10%; right: -10%; bottom: -40px;
      height: 110px;
      background: radial-gradient(circle at 50% -40px, #aaf0a6, #7ed957);
      transform: rotate(-2deg);
    }
    .animal-area {
      position: relative;
      width: 100%; height: 100%;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-auto-rows: 64px;
      align-content: center;
      justify-items: center;
      gap: 8px 6px;
      padding: 8px 6px 24px;
    }
    .animal {
      font-size: 44px;
      line-height: 1;
      cursor: pointer;
      user-select: none;
      touch-action: manipulation;
      filter: drop-shadow(0 3px 0 rgba(0,0,0,0.08));
      transition: transform 0.12s ease, opacity 0.2s ease;
    }
    .animal.tap {
      transform: translateY(-4px) scale(1.06);
    }
    .animal.selected { outline: 4px solid rgba(255, 105, 180, 0.5); border-radius: 12px; }

    .runaway { animation: runaway 0.7s ease forwards; }
    @keyframes runaway {
      30% { transform: translateX(10px) rotate(-6deg); }
      100% { transform: translate(140px, -40px) rotate(20deg); opacity: 0; }
    }

    .dance { animation: dance 0.8s ease-in-out 2; }
    @keyframes dance {
      0%, 100% { transform: translateY(0) scale(1); }
      25% { transform: rotate(-8deg) translateY(-10px) scale(1.1); }
      50% { transform: rotate(8deg) translateY(-6px); }
      75% { transform: rotate(-4deg) translateY(-4px); }
    }

    .controls {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    /* „ÇΩ„Éï„Éà„Ç≠„Éº„Éú„Éº„Éâ */
    .softpad { margin-top: 8px; display: grid; grid-template-columns: repeat(3, 80px); gap: 8px; justify-content: center; }
    .key { background: #ffffff; color: #2d3436; border: 2px solid #cbd5e1; border-radius: 12px; font-weight: 900; font-size: 1.4rem; padding: 12px 0; box-shadow: 0 2px 0 rgba(0,0,0,0.06); }
    .key:active { transform: translateY(1px); }
    .key.wide { grid-column: span 2; }
    @media (max-width: 520px) { .softpad { grid-template-columns: repeat(3, 28vw); } }
    .btn {
      background: linear-gradient(45deg, var(--pink), #e84393);
      color: #fff;
      border: none;
      padding: 12px 18px;
      font-size: 1.2rem;
      font-weight: 800;
      border-radius: 16px;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(232,67,147,0.3);
    }
    .btn.secondary { background: linear-gradient(45deg, var(--blue), #6c5ce7); box-shadow: 0 10px 24px rgba(108,92,231,0.3); }

    .feedback { margin-top: 6px; min-height: 36px; font-size: 1.2rem; font-weight: 800; text-align: center; }
    .correct { color: #00b894; }
    .incorrect { color: #e17055; }

    .stars-reward { text-align: center; margin-top: 4px; font-size: 1.1rem; }

    .star-burst { position: absolute; inset: 0; pointer-events: none; }
    .star { position: absolute; font-size: 24px; animation: starfly 0.9s ease-out forwards; }
    @keyframes starfly {
      from { transform: translate(var(--sx,0), var(--sy,0)) scale(0.2); opacity: 0; }
      to   { transform: translate(var(--tx,0), var(--ty,0)) scale(1.2); opacity: 1; }
    }

    /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
    @media (max-width: 760px) { .equation { font-size: 2rem; } .animal { font-size: 42px; } }
    @media (max-width: 520px) { .equation { font-size: 1.8rem; } .animal { font-size: 40px; } }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="„Å©„ÅÜ„Å∂„Å§„Å≤„Åç„Åñ„Çì„Ç≤„Éº„É†">
    <div class="title">ü¶ì „Å©„ÅÜ„Å∂„Å§ „Å≤„Åç„Åñ„Çì üêí</div>
    <div class="equation" id="equation">8 - 3 = ?</div>

    <div class="level-select" role="group" aria-label="„É¨„Éô„É´„Åõ„Çì„Åü„Åè">
      <button class="level-btn active" id="lv-easy">„Åã„Çì„Åü„Çì 1-5</button>
      <button class="level-btn" id="lv-medium">„Åµ„Å§„ÅÜ 6-10</button>
    </div>

    <div class="stats">
      <div class="pill" id="streak">„Çå„Çì„Åó„Çá„ÅÜ: 0</div>
      <div class="pill" id="stars">„Çπ„Çø„Éº: 0</div>
    </div>

    <div class="progress-wrap" aria-label="„Çå„Çì„Åó„ÇÖ„ÅÜ„ÅÆ „Åó„Çì„Å°„Çá„Åè">
      <div class="progress-bar" id="progress"></div>
    </div>

    <div class="pen" id="pen" aria-label="„Å©„ÅÜ„Å∂„Å§„ÅÆ „ÅÑ„Åë„Åå„Åç">
      <div class="animal-area" id="animals"></div>
      <div class="ground"></div>
      <div class="star-burst" id="starBurst"></div>
    </div>

    <div class="controls">
      <button class="btn" id="checkBtn">„Åì„Åü„Åà„ÇãÔºÅ</button>
      <button class="btn secondary" id="nextBtn">„Å§„Åé„ÅÆ„ÇÇ„Çì„Å†„ÅÑ</button>
      <button class="btn secondary" id="restartBtn">„Åï„ÅÑ„Åó„Çá„Åã„Çâ</button>
    </div>
    <div class="softpad" id="softpad" aria-label="„ÇΩ„Éï„Éà„Ç≠„Éº„Éú„Éº„Éâ">
      <button class="key">1</button>
      <button class="key">2</button>
      <button class="key">3</button>
      <button class="key">4</button>
      <button class="key">5</button>
      <button class="key">6</button>
      <button class="key">7</button>
      <button class="key">8</button>
      <button class="key">9</button>
      <button class="key wide">0</button>
      <button class="key" data-action="back">‚å´</button>
    </div>

    <div class="feedback" id="feedback" aria-live="polite"></div>
    <div class="stars-reward" id="starsReward" aria-hidden="true"></div>
  </div>

  <script>
    // „É¨„Éô„É´Ë®≠ÂÆö
    const LEVELS = {
      easy: { min: 1, max: 5 },
      medium: { min: 6, max: 10 }
    };

    // Áä∂ÊÖã
    let level = 'easy';
    let a = 8, b = 3; // a - b = ans
    let ans = 5;
    let streak = 0;      // Ê≠£Ëß£ÈÄ£Á∂öÊï∞
    let stars = 0;       // Áç≤Âæó„Çπ„Çø„ÉºÂêàË®à
    let cycle = 0;       // 0..10 „Åß„Éó„É≠„Ç∞„É¨„Çπ
    let selecting = true; // ÈÅ∏ÊäûÂèó‰ªò‰∏≠
    let audioCtx = null;
    let removedCount = 0; // „Åì„ÅÆÂïèÈ°å„ÅßÊ∂à„Åó„ÅüÂåπÊï∞Ôºà‰∏äÈôê bÔºâ

    const equationEl = document.getElementById('equation');
    const animalsEl = document.getElementById('animals');
    const feedbackEl = document.getElementById('feedback');
    const starsEl = document.getElementById('stars');
    const streakEl = document.getElementById('streak');
    const progressEl = document.getElementById('progress');
    const starBurst = document.getElementById('starBurst');

    // ÂàùÊúüÂåñ
    init();

    function init() {
      setupAudioWarmup();
      setupButtons();
      resetSession(false);
      newProblem();
    }

    function setupButtons() {
      document.getElementById('lv-easy').addEventListener('click', () => changeLevel('easy'));
      document.getElementById('lv-medium').addEventListener('click', () => changeLevel('medium'));
      document.getElementById('checkBtn').addEventListener('click', checkAnswer);
      document.getElementById('nextBtn').addEventListener('click', newProblem);
      document.getElementById('restartBtn').addEventListener('click', () => resetSession(true));
    }

    function setupAudioWarmup() {
      const warm = () => {
        if (!audioCtx) {
          try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch (e) {}
        }
        window.removeEventListener('pointerdown', warm);
        window.removeEventListener('touchstart', warm);
      };
      window.addEventListener('pointerdown', warm, { once: true });
      window.addEventListener('touchstart', warm, { once: true });
    }

    function changeLevel(lv) {
      level = lv;
      document.getElementById('lv-easy').classList.toggle('active', lv === 'easy');
      document.getElementById('lv-medium').classList.toggle('active', lv === 'medium');
      resetSession(false);
      newProblem();
      playTick();
    }

    function resetSession(showMsg) {
      streak = 0;
      cycle = 0;
      feedbackEl.textContent = showMsg ? 'üîÑ „Åï„ÅÑ„Åó„Çá„Åã„ÇâÔºÅ' : '';
      updateHUD();
    }

    function updateHUD() {
      streakEl.textContent = `„Çå„Çì„Åó„Çá„ÅÜ: ${streak}`;
      starsEl.textContent = `„Çπ„Çø„Éº: ${stars}`;
      progressEl.style.width = `${(cycle % 10) * 10}%`;
    }

    function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

    function newProblem() {
      animalsEl.innerHTML = '';
      feedbackEl.textContent = '';
      const { min, max } = LEVELS[level];
      a = randInt(min, max);
      b = randInt(1, a); // ÂÄü„Çä„Å™„ÅóÔºàa>=bÔºâ
      ans = a - b;
      equationEl.textContent = `${a} - ${b} = ?`;
      removedCount = 0;
      spawnAnimals();
      selecting = true; // „Åô„ÅêÊìç‰ΩúOK
    }

    function spawnAnimals() {
      animalsEl.innerHTML = '';
      const animalEmoji = 'üêµ';
      for (let i = 0; i < a; i++) {
        const el = document.createElement('div');
        el.className = 'animal';
        el.textContent = animalEmoji;
        enableTap(el);
        animalsEl.appendChild(el);
      }
    }

    function enableTap(el) {
      const onDown = (e) => {
        if (!selecting) return;
        e.preventDefault();
        el.classList.add('tap');
      };
      const onUp = (e) => {
        if (!selecting) return;
        e.preventDefault();
        el.classList.remove('tap');
        // „Åæ„Å† b Âåπ„Å´ÈÅî„Åó„Å¶„ÅÑ„Å™„ÅÑÊôÇ„Å†„Åë„ÄÅ„Å´„Åí„Çã
        if (removedCount < b && el.isConnected) {
          el.classList.add('runaway');
          playPop();
          removedCount++;
          el.addEventListener('animationend', () => {
            el.remove();
          }, { once: true });
        } else {
          // „Åì„Çå‰ª•‰∏äÊ∂à„Åõ„Å™„ÅÑ„Å®„Åç„ÅØËªΩ„Åè„Éí„É≥„ÉàÈü≥
          playTick();
        }
      };
      el.addEventListener('pointerdown', onDown);
      el.addEventListener('pointerup', onUp);
      el.addEventListener('touchstart', (e) => e.preventDefault(), { passive: false });
    }

    function checkAnswer() {
      if (!selecting) return;
      const remaining = animalsEl.querySelectorAll('.animal').length;
      if (remaining === ans) {
        streak++;
        stars++;
        cycle = (cycle + 1) % 10;
        feedbackEl.className = 'feedback correct';
        feedbackEl.textContent = 'üéâ „Åõ„ÅÑ„Åã„ÅÑÔºÅ„ÇÑ„Å£„Åü„Å≠ÔºÅ';
        // „ÉÄ„É≥„ÇπÔºàÊÆã„Å£„Å¶„ÅÑ„Çã„Å©„ÅÜ„Å∂„Å§Ôºâ
        animalsEl.querySelectorAll('.animal').forEach(n => n.classList.add('dance'));
        // „Çπ„Çø„ÉºÊºîÂá∫
        starBurstFx();
        playSuccess();
        updateHUD();
        setTimeout(newProblem, 1000);
      } else {
        // „ÇΩ„Éï„Éà„É™„Çª„ÉÉ„ÉàÔºàÂêå„ÅòÂïèÈ°å„Çí„ÇÑ„ÇäÁõ¥„ÅóÔºâ
        feedbackEl.className = 'feedback incorrect';
        feedbackEl.textContent = 'üòä „ÅÆ„Åì„Çä„Çí ' + ans + ' „Å≤„Åç„Å´ „Å™„Çã„Çà„ÅÜ„Å´ „Åë„Åó„Å¶„Åø„Çà„ÅÜÔºÅ';
        playHint();
        setTimeout(() => {
          removedCount = 0;
          spawnAnimals();
        }, 700);
      }
    }

    // „ÇΩ„Éï„Éà„Ç≠„Éº„Éú„Éº„Éâ
    (function(){
      const soft = document.getElementById('softpad');
      const buf = { v: '' };
      soft.addEventListener('click', (e) => {
        const btn = e.target.closest('.key'); if (!btn) return;
        const action = btn.getAttribute('data-action');
        if (action === 'back') { buf.v = buf.v.slice(0, -1); }
        else if (buf.v.length < 2) { buf.v += btn.textContent.trim(); }
        // ÂÖ•Âäõ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅÊÆã„ÇäÂåπÊï∞„Å®ÊØîËºÉ
        if (buf.v === '') return;
        const tryVal = parseInt(buf.v, 10);
        const remaining = animalsEl.querySelectorAll('.animal').length;
        if (!Number.isNaN(tryVal)) {
          if (tryVal === remaining) { checkAnswer(); buf.v=''; }
        }
      });
    })();

    function starBurstFx() {
      const pos = animalsEl.getBoundingClientRect();
      for (let i = 0; i < 10; i++) {
        const s = document.createElement('div');
        s.className = 'star';
        s.textContent = '‚≠ê';
        const tx = (Math.random() * pos.width - pos.width/2) + 'px';
        const ty = (Math.random() * -80 - 20) + 'px';
        s.style.setProperty('--sx', '0px');
        s.style.setProperty('--sy', '0px');
        s.style.setProperty('--tx', tx);
        s.style.setProperty('--ty', ty);
        s.style.left = (pos.width/2) + 'px';
        s.style.top = (pos.height/2) + 'px';
        starBurst.appendChild(s);
        setTimeout(() => s.remove(), 900);
      }
      const msg = document.getElementById('starsReward');
      msg.textContent = '‚≠ê „Çí 1„Åì „Å¶„Å´„ÅÑ„Çå„Åü„ÇàÔºÅ';
      setTimeout(() => { msg.textContent = ''; }, 1200);
    }

    // „Çµ„Ç¶„É≥„Éâ
    function playTone(freq = 880, dur = 0.18, type = 'sine', gain = 0.06) {
      if (!audioCtx) return;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type;
      o.frequency.value = freq;
      g.gain.value = gain;
      o.connect(g).connect(audioCtx.destination);
      o.start();
      o.stop(audioCtx.currentTime + dur);
    }
    function playSuccess() {
      if (!audioCtx) return;
      const seq = [
        { f: 659, d: 0.12 },
        { f: 784, d: 0.12 },
        { f: 988, d: 0.18 },
      ];
      let t = 0;
      for (const s of seq) {
        setTimeout(() => playTone(s.f, s.d, 'triangle', 0.07), t * 1000);
        t += s.d * 0.75;
      }
    }
    function playPop() { playTone(500, 0.06, 'sine', 0.04); }
    function playHint() { playTone(220, 0.18, 'sawtooth', 0.03); }
    function playRunaway() { playTone(400, 0.10, 'square', 0.03); }
    function playTick() { playTone(740, 0.05, 'sine', 0.03); }
  </script>
</body>
</html>


